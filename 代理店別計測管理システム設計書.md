# 株式会社イケメン 代理店管理システム 完全設計書

**バージョン:** 2.0
**最終更新:** 2025-10-24
**対象システム:** マルチサービス対応代理店管理プラットフォーム
**プラットフォーム:** Netlify Functions + Supabase PostgreSQL

---

## 📋 目次

1. [システム概要](#システム概要)
2. [システムアーキテクチャ](#システムアーキテクチャ)
3. [データベース設計](#データベース設計)
4. [API仕様](#api仕様)
5. [ビジネスロジック](#ビジネスロジック)
6. [認証・セキュリティ](#認証セキュリティ)
7. [デプロイ手順](#デプロイ手順)

---

## システム概要

### 目的

株式会社イケメンが提供する複数のLINE公式アカウントサービスを、代理店経由で販売・管理するためのプラットフォーム。代理店は専用のトラッキングリンクを通じてユーザーを獲得し、コンバージョンに応じて報酬を得る。

### 対応サービス（2025年10月時点）

| サービス名 | 説明 | 月額料金 | デフォルト報酬率 |
|-----------|------|---------|----------------|
| TaskMate AI | AI搭載タスク管理アシスタント | 10,000円 | 20% |
| LiteWEB+ | 軽量・高速Webサービス | 8,000円 | 15% |
| IT補助金サポート | IT補助金申請LINEサポート | 50,000円 | 10% |
| ものづくり補助金サポート | ものづくり補助金申請サポート | 80,000円 | 10% |

### 主要機能

**代理店向け:**
- 階層型リファラルシステム（最大4階層）
- サービス別トラッキングリンク生成
- リアルタイム統計ダッシュボード
- サービス別フィルタリング
- 報酬管理・レポート

**管理者向け:**
- 代理店承認・管理
- 全体統計の閲覧
- サービス管理
- コミッション管理

### システム構成

```
┌─────────────────┐
│  ユーザー        │
│  (LINE友達追加)  │
└────────┬────────┘
         │
         │ ① トラッキングリンククリック
         ↓
┌─────────────────────────────────────┐
│  Netlify (agency.ikemen.ltd)         │
│  - トラッキング・リダイレクト          │
│  - 代理店ダッシュボード               │
│  - 管理画面                          │
└────────┬────────────────────────────┘
         │
         │ ② データ保存・取得
         ↓
┌─────────────────────────────────────┐
│  Supabase PostgreSQL                 │
│  - 代理店データ                       │
│  - トラッキングデータ                 │
│  - サービスデータ                     │
│  - コンバージョンデータ               │
└─────────────────────────────────────┘
```

---

## システムアーキテクチャ

### プラットフォーム役割分担

| プラットフォーム | 役割 | 主要機能 |
|----------------|------|---------|
| **Netlify Functions** | フロントエンド + サーバーレスAPI | - 代理店ダッシュボード<br>- 管理画面<br>- トラッキングAPI<br>- 認証API |
| **Supabase** | データベース | - PostgreSQL 47テーブル<br>- Row Level Security<br>- リアルタイムクエリ |

### データフロー（トラッキング→コンバージョン）

```
1. トラッキングリンク作成
   代理店 → Netlify (agency-create-link)
         → Supabase (agency_tracking_links に保存)

2. ユーザー訪問
   ユーザー → Netlify (track-redirect)
          → Supabase (agency_tracking_visits に訪問記録)
          → リダイレクト（LINE友達追加URL）

3. LINE友達追加
   LINE Webhook → Netlify (line-webhook)
              → Supabase (agency_conversions にコンバージョン記録)
              → tracking_links.conversion_count をインクリメント

4. 報酬計算（月次）
   管理者 → Netlify (agency-commission)
         → Supabase (agency_commissions に報酬記録)
```

---

## データベース設計

### ER図（主要テーブル）

```
┌─────────────────┐
│   services      │ サービスマスター（TaskMate AI、LiteWEB+など）
│─────────────────│
│ id (PK)         │
│ name            │
│ domain          │
│ line_channel_id │
│ commission_rate │
└────────┬────────┘
         │
         │ 1:N
         ↓
┌──────────────────────┐
│ agency_service_      │ 代理店×サービス設定
│ settings             │
│──────────────────────│
│ agency_id (FK)       │───┐
│ service_id (FK)      │   │
│ commission_rate      │   │
│ is_active            │   │
└──────────────────────┘   │
                           │
                           │
         ┌─────────────────┘
         │
         ↓
┌─────────────────┐
│   agencies      │ 代理店マスター
│─────────────────│
│ id (PK)         │
│ code (UNIQUE)   │ 例: AG1A2B3C
│ name            │
│ level           │ 1~4（階層レベル）
│ parent_id (FK)  │ 親代理店ID
│ commission_rate │ 報酬率
│ status          │ pending/active/suspended
└────────┬────────┘
         │
         │ 1:N
         ↓
┌──────────────────┐
│ agency_users     │ 代理店ユーザー
│──────────────────│
│ id (PK)          │
│ agency_id (FK)   │
│ email (UNIQUE)   │
│ password_hash    │
│ role             │ owner/admin/member
└──────────────────┘

         │
         │ 1:N
         ↓
┌──────────────────────┐
│ agency_tracking_     │ トラッキングリンク
│ links                │
│──────────────────────│
│ id (PK)              │
│ agency_id (FK)       │
│ service_id (FK)      │ ← マルチサービス対応
│ tracking_code        │ 例: abc123xyz
│ line_friend_url      │
│ visit_count          │
│ conversion_count     │
└────────┬─────────────┘
         │
         │ 1:N
         ↓
┌──────────────────────┐
│ agency_tracking_     │ 訪問記録
│ visits               │
│──────────────────────│
│ id (PK)              │
│ tracking_link_id(FK) │
│ agency_id (FK)       │
│ service_id (FK)      │ ← マルチサービス対応
│ visitor_ip           │
│ device_type          │
│ session_id           │
│ created_at           │
└──────────────────────┘

         │
         │ 1:N
         ↓
┌──────────────────────┐
│ agency_conversions   │ コンバージョン記録
│──────────────────────│
│ id (PK)              │
│ tracking_link_id(FK) │
│ agency_id (FK)       │
│ service_id (FK)      │ ← マルチサービス対応
│ visit_id (FK)        │
│ line_user_id         │
│ conversion_type      │ line_friend/purchase
│ conversion_value     │
│ created_at           │
└──────────────────────┘

         │
         │ N:1（月次集計）
         ↓
┌──────────────────────┐
│ agency_commissions   │ 報酬管理
│──────────────────────│
│ id (PK)              │
│ agency_id (FK)       │
│ service_id (FK)      │ ← マルチサービス対応
│ period_start         │
│ period_end           │
│ commission_amount    │
│ status               │ pending/approved/paid
│ payment_date         │
└──────────────────────┘
```

### テーブル詳細仕様

#### 1. services（サービスマスター）

**目的:** 提供サービス（TaskMate AI、LiteWEB+など）の管理

| カラム名 | 型 | 制約 | 説明 | 例 |
|---------|-----|-----|------|-----|
| id | UUID | PK | サービスID | `b5e8f3c2-...` |
| name | TEXT | NOT NULL | サービス名 | `TaskMate AI` |
| description | TEXT | | サービス説明 | `AI搭載タスク管理...` |
| status | TEXT | CHECK | ステータス | `active`/`inactive` |
| domain | TEXT | UNIQUE, NOT NULL | ドメイン | `taskmateai.net` |
| tracking_base_url | TEXT | NOT NULL | トラッキングベースURL | `https://taskmateai.net/t` |
| app_redirect_url | TEXT | NOT NULL | アプリリダイレクトURL | `https://taskmateai.net/app` |
| line_channel_id | TEXT | UNIQUE, NOT NULL | LINE Channel ID | `1234567890` |
| line_channel_secret | TEXT | NOT NULL | LINE Channel Secret | `xxx...` |
| line_channel_access_token | TEXT | NOT NULL | LINE Access Token | `yyy...` |
| line_official_url | TEXT | NOT NULL | LINE公式アカウントURL | `https://lin.ee/FMy4xlx` |
| default_commission_rate | DECIMAL(5,2) | NOT NULL | デフォルト報酬率(%) | `20.00` |
| default_referral_rate | DECIMAL(5,2) | NOT NULL | リファラル報酬率(%) | `2.00` |
| subscription_price | INTEGER | NOT NULL | 月額料金（円） | `10000` |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 | |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 | |

**インデックス:**
- `idx_services_status` ON (status)
- `idx_services_domain` ON (domain)

---

#### 2. agencies（代理店マスター）

**目的:** 代理店の基本情報と階層管理

| カラム名 | 型 | 制約 | 説明 | 例 |
|---------|-----|-----|------|-----|
| id | UUID | PK | 代理店ID | `uuid-...` |
| code | VARCHAR(50) | UNIQUE, NOT NULL | 代理店コード（招待用） | `AG1A2B3C4D` |
| name | VARCHAR(255) | NOT NULL | 代理店名 | `株式会社ABC` |
| company_name | VARCHAR(255) | | 正式会社名 | `株式会社ABC` |
| contact_email | VARCHAR(255) | NOT NULL | 連絡先メール | `contact@abc.com` |
| contact_phone | VARCHAR(50) | | 連絡先電話 | `03-1234-5678` |
| address | TEXT | | 住所 | `東京都...` |
| status | VARCHAR(50) | CHECK | ステータス | `pending`/`active`/`suspended`/`rejected` |
| level | INTEGER | DEFAULT 1 | 階層レベル（1~4） | `1` |
| parent_id | UUID | FK → agencies(id) | 親代理店ID | `uuid-...` |
| commission_rate | DECIMAL(5,2) | DEFAULT 20.00 | 報酬率(%) | `20.00` |
| payment_info | JSONB | | 振込先情報 | `{"bank":"みずほ",...}` |
| line_user_id | VARCHAR(255) | UNIQUE | LINE User ID（登録用） | `U1234...` |
| settings | JSONB | DEFAULT '{}' | カスタム設定 | `{}` |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 | |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 | |

**ビジネスルール:**
- `level`: 1~4の階層構造（1が最上位）
- `status`:
  - `pending`: 登録申請中（LINE友達追加待ち）
  - `active`: アクティブ（ログイン・リンク作成可能）
  - `suspended`: 一時停止
  - `inactive`: 無効化
  - `rejected`: 却下
- 階層別デフォルト報酬率:
  - Level 1: 20%
  - Level 2: 18%
  - Level 3: 16%
  - Level 4: 14%

**インデックス:**
- `idx_agencies_code` ON (code)
- `idx_agencies_status` ON (status)
- `idx_agencies_parent_id` ON (parent_id)
- `idx_agencies_level` ON (level)

---

#### 3. agency_users（代理店ユーザー）

**目的:** 代理店にログインするユーザーアカウント

| カラム名 | 型 | 制約 | 説明 | 例 |
|---------|-----|-----|------|-----|
| id | UUID | PK | ユーザーID | `uuid-...` |
| agency_id | UUID | FK → agencies(id), NOT NULL | 所属代理店ID | `uuid-...` |
| email | VARCHAR(255) | UNIQUE, NOT NULL | メールアドレス | `user@abc.com` |
| password_hash | VARCHAR(255) | NOT NULL | bcryptパスワードハッシュ | `$2a$10$...` |
| name | VARCHAR(255) | NOT NULL | ユーザー名 | `山田太郎` |
| role | VARCHAR(50) | CHECK, DEFAULT 'member' | 権限 | `owner`/`admin`/`member` |
| is_active | BOOLEAN | DEFAULT true | アクティブフラグ | `true` |
| last_login_at | TIMESTAMP | | 最終ログイン日時 | |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 | |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 | |

**ビジネスルール:**
- `role`:
  - `owner`: オーナー（代理店作成者、全権限）
  - `admin`: 管理者（ユーザー管理以外の全権限）
  - `member`: メンバー（閲覧のみ）
- パスワードは bcrypt でハッシュ化（cost=10）

**インデックス:**
- `idx_agency_users_agency_id` ON (agency_id)
- `idx_agency_users_email` ON (email)

---

#### 4. agency_service_settings（代理店×サービス設定）

**目的:** 代理店ごとにサービス別の報酬率をカスタマイズ

| カラム名 | 型 | 制約 | 説明 | 例 |
|---------|-----|-----|------|-----|
| id | UUID | PK | 設定ID | `uuid-...` |
| agency_id | UUID | FK → agencies(id), NOT NULL | 代理店ID | `uuid-...` |
| service_id | UUID | FK → services(id), NOT NULL | サービスID | `uuid-...` |
| commission_rate | DECIMAL(5,2) | | カスタム報酬率(%) | `25.00` |
| referral_rate | DECIMAL(5,2) | | カスタムリファラル率(%) | `3.00` |
| is_active | BOOLEAN | DEFAULT true | 有効フラグ | `true` |
| notes | TEXT | | メモ | `特別契約により25%` |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 | |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 | |

**UNIQUE制約:** (agency_id, service_id)

**ビジネスルール:**
- NULL の場合は `services.default_commission_rate` を使用
- `is_active=false` の場合、該当サービスのリンク作成不可

**インデックス:**
- `idx_agency_service_settings_agency` ON (agency_id)
- `idx_agency_service_settings_service` ON (service_id)
- `idx_agency_service_settings_active` ON (is_active)

---

#### 5. agency_tracking_links（トラッキングリンク）

**目的:** 代理店が生成するトラッキング用URL

| カラム名 | 型 | 制約 | 説明 | 例 |
|---------|-----|-----|------|-----|
| id | UUID | PK | リンクID | `uuid-...` |
| agency_id | UUID | FK → agencies(id), NOT NULL | 代理店ID | `uuid-...` |
| service_id | UUID | FK → services(id) | サービスID | `uuid-...` |
| created_by | UUID | FK → agency_users(id), NOT NULL | 作成者ID | `uuid-...` |
| tracking_code | VARCHAR(20) | UNIQUE, NOT NULL | トラッキングコード | `abc123xyz` |
| name | VARCHAR(255) | NOT NULL | キャンペーン名 | `秋キャンペーン` |
| utm_source | VARCHAR(255) | | UTMソース | `facebook` |
| utm_medium | VARCHAR(255) | | UTMメディア | `cpc` |
| utm_campaign | VARCHAR(255) | | UTMキャンペーン | `autumn2025` |
| utm_term | VARCHAR(255) | | UTMタム | `task-management` |
| utm_content | VARCHAR(255) | | UTMコンテンツ | `ad-variant-a` |
| line_friend_url | TEXT | NOT NULL | LINE友達追加URL | `https://lin.ee/xxx` |
| destination_url | TEXT | | カスタムリダイレクト先 | `https://taskmateai.net/app` |
| is_active | BOOLEAN | DEFAULT true | アクティブフラグ | `true` |
| visit_count | INTEGER | DEFAULT 0 | 訪問数 | `150` |
| conversion_count | INTEGER | DEFAULT 0 | コンバージョン数 | `25` |
| metadata | JSONB | DEFAULT '{}' | メタデータ | `{}` |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 | |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 | |

**ビジネスルール:**
- `tracking_code`: 12文字のランダム英数字（重複チェック済み）
- トラッキングURL形式: `https://agency.ikemen.ltd/t/{tracking_code}`
- `service_id` が NULL の場合は後方互換（環境変数のLINE URLを使用）

**インデックス:**
- `idx_agency_tracking_links_agency_id` ON (agency_id)
- `idx_agency_tracking_links_service` ON (service_id)
- `idx_agency_tracking_links_tracking_code` ON (tracking_code)

---

#### 6. agency_tracking_visits（訪問記録）

**目的:** トラッキングリンクのクリック記録

| カラム名 | 型 | 制約 | 説明 | 例 |
|---------|-----|-----|------|-----|
| id | UUID | PK | 訪問ID | `uuid-...` |
| tracking_link_id | UUID | FK → agency_tracking_links(id), NOT NULL | リンクID | `uuid-...` |
| agency_id | UUID | FK → agencies(id), NOT NULL | 代理店ID | `uuid-...` |
| service_id | UUID | FK → services(id) | サービスID | `uuid-...` |
| visitor_ip | VARCHAR(50) | | 訪問者IP | `123.45.67.89` |
| user_agent | TEXT | | User-Agent | `Mozilla/5.0...` |
| referrer | TEXT | | リファラー | `https://facebook.com` |
| device_type | VARCHAR(50) | | デバイス種別 | `mobile`/`desktop`/`tablet` |
| browser | VARCHAR(100) | | ブラウザ | `Chrome`/`Safari`/`LINE` |
| os | VARCHAR(100) | | OS | `iOS`/`Android`/`Windows` |
| session_id | VARCHAR(100) | | セッションID | `sess_abc123...` |
| line_user_id | VARCHAR(255) | | LINE User ID（友達追加後に紐付け） | `U1234...` |
| metadata | JSONB | DEFAULT '{}' | メタデータ | `{"utm_source":"fb"}` |
| created_at | TIMESTAMP | DEFAULT NOW() | 訪問日時 | |

**ビジネスルール:**
- 訪問時点では `line_user_id` は NULL
- LINE友達追加後、1時間以内の訪問記録と紐付け

**インデックス:**
- `idx_agency_tracking_visits_tracking_link_id` ON (tracking_link_id)
- `idx_agency_tracking_visits_agency_id` ON (agency_id)
- `idx_agency_tracking_visits_service` ON (service_id)
- `idx_agency_tracking_visits_created_at` ON (created_at)
- `idx_agency_tracking_visits_line_user_id` ON (line_user_id)

---

#### 7. agency_conversions（コンバージョン記録）

**目的:** LINE友達追加や購入などのコンバージョン記録

| カラム名 | 型 | 制約 | 説明 | 例 |
|---------|-----|-----|------|-----|
| id | UUID | PK | コンバージョンID | `uuid-...` |
| tracking_link_id | UUID | FK → agency_tracking_links(id), NOT NULL | リンクID | `uuid-...` |
| agency_id | UUID | FK → agencies(id), NOT NULL | 代理店ID | `uuid-...` |
| service_id | UUID | FK → services(id) | サービスID | `uuid-...` |
| visit_id | UUID | FK → agency_tracking_visits(id) | 訪問ID | `uuid-...` |
| user_id | UUID | FK → users(id) | ユーザーID | `uuid-...` |
| session_id | VARCHAR(100) | | セッションID | `sess_abc123...` |
| conversion_type | VARCHAR(50) | NOT NULL | コンバージョン種別 | `line_friend`/`purchase`/`signup` |
| conversion_value | DECIMAL(10,2) | | コンバージョン額 | `10000.00` |
| line_user_id | VARCHAR(255) | | LINE User ID | `U1234...` |
| line_display_name | VARCHAR(255) | | LINE表示名 | `山田太郎` |
| line_picture_url | TEXT | | LINEプロフィール画像URL | `https://...` |
| metadata | JSONB | DEFAULT '{}' | メタデータ | `{"utm_campaign":"..."}` |
| created_at | TIMESTAMP | DEFAULT NOW() | コンバージョン日時 | |

**ビジネスルール:**
- `conversion_type`:
  - `line_friend`: LINE友達追加（conversion_value=0）
  - `purchase`: サブスク購入（conversion_value=月額料金）
  - `signup`: 会員登録
- 同一 session_id で重複コンバージョン記録は作成しない

**インデックス:**
- `idx_agency_conversions_agency_id` ON (agency_id)
- `idx_agency_conversions_service` ON (service_id)
- `idx_agency_conversions_tracking_link_id` ON (tracking_link_id)
- `idx_agency_conversions_line_user_id` ON (line_user_id)
- `idx_agency_conversions_created_at` ON (created_at)

---

#### 8. agency_commissions（報酬管理）

**目的:** 代理店への月次報酬計算・管理

| カラム名 | 型 | 制約 | 説明 | 例 |
|---------|-----|-----|------|-----|
| id | UUID | PK | 報酬ID | `uuid-...` |
| agency_id | UUID | FK → agencies(id), NOT NULL | 代理店ID | `uuid-...` |
| service_id | UUID | FK → services(id) | サービスID | `uuid-...` |
| period_start | DATE | NOT NULL | 期間開始日 | `2025-10-01` |
| period_end | DATE | NOT NULL | 期間終了日 | `2025-10-31` |
| total_conversions | INTEGER | DEFAULT 0 | 総コンバージョン数 | `25` |
| total_sales | DECIMAL(12,2) | DEFAULT 0 | 総売上額 | `250000.00` |
| commission_rate | DECIMAL(5,2) | NOT NULL | 適用報酬率(%) | `20.00` |
| commission_amount | DECIMAL(12,2) | DEFAULT 0 | 報酬額 | `50000.00` |
| status | VARCHAR(50) | CHECK, DEFAULT 'pending' | ステータス | `pending`/`approved`/`paid`/`cancelled` |
| payment_date | DATE | | 支払日 | `2025-11-15` |
| payment_method | VARCHAR(100) | | 支払方法 | `bank_transfer` |
| payment_reference | VARCHAR(255) | | 支払参照番号 | `TRX123456` |
| notes | TEXT | | メモ | `振込完了` |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 | |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 | |

**UNIQUE制約:** (agency_id, service_id, period_start, period_end)

**ビジネスルール:**
- 月次で自動計算（管理者が実行）
- 計算式:
  ```
  commission_amount = total_sales × commission_rate / 100
  ```
- `status`:
  - `pending`: 承認待ち
  - `approved`: 承認済み（支払待ち）
  - `paid`: 支払済み
  - `cancelled`: キャンセル

**インデックス:**
- `idx_agency_commissions_agency_id` ON (agency_id)
- `idx_agency_commissions_service` ON (service_id)
- `idx_agency_commissions_period` ON (period_start, period_end)
- `idx_agency_commissions_status` ON (status)

---

### データベースセキュリティ

#### Row Level Security (RLS)

全テーブルでRLS有効化。各代理店は自分のデータのみアクセス可能。

```sql
-- 例: 代理店は自分のデータのみ閲覧可能
CREATE POLICY "Agencies can view own data" ON agencies
    FOR SELECT USING (id = auth.jwt() ->> 'agency_id'::uuid);

CREATE POLICY "Agency can manage own tracking links" ON agency_tracking_links
    FOR ALL USING (agency_id = auth.jwt() ->> 'agency_id'::uuid);
```

#### トリガー

自動更新日時の更新:

```sql
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_agencies_updated_at
    BEFORE UPDATE ON agencies
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();
```

---

## API仕様

### 認証

#### POST /.netlify/functions/agency-auth

**目的:** 代理店ユーザーのログイン

**リクエスト:**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**レスポンス（成功）:**
```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "user": {
    "id": "uuid-...",
    "email": "user@example.com",
    "name": "山田太郎",
    "role": "owner"
  },
  "agency": {
    "id": "uuid-...",
    "name": "株式会社ABC",
    "code": "AG1A2B3C",
    "status": "active"
  }
}
```

**レスポンス（エラー）:**
```json
{
  "error": "メールアドレスまたはパスワードが正しくありません"
}
```

**認証方式:**
- JWT（JSON Web Token）
- Cookie: `agencyAuthToken` (httpOnly=true, secure=true)
- 有効期限: 7日間

---

#### POST /.netlify/functions/agency-register

**目的:** 新規代理店登録

**リクエスト:**
```json
{
  "company_name": "株式会社ABC",
  "agency_name": "ABC代理店",
  "address": "東京都渋谷区...",
  "contact_name": "山田太郎",
  "email": "contact@abc.com",
  "phone": "03-1234-5678",
  "password": "SecurePass123!",
  "invitation_code": "AG1A2B3C"
}
```

**処理フロー:**
1. 招待コード検証（親代理店の存在確認）
2. 階層レベル計算（親レベル+1、最大4）
3. 報酬率決定（レベルに応じて20%/18%/16%/14%）
4. メール重複チェック
5. パスワードハッシュ化（bcrypt）
6. `agencies` テーブルに挿入（status=`pending`）
7. `agency_users` テーブルに挿入
8. 登録トークン生成
9. LINE認証URL返却

**レスポンス（成功）:**
```json
{
  "success": true,
  "agency_id": "uuid-...",
  "agency_code": "AG2B3C4D5E",
  "level": 2,
  "commission_rate": 18.00,
  "line_auth_url": "https://access.line.me/oauth2/v2.1/authorize?...",
  "message": "登録が完了しました。LINEで友達追加して認証を完了してください。"
}
```

**ビジネスルール:**
- 階層別報酬率:
  - Level 1: 20%
  - Level 2: 18%
  - Level 3: 16%
  - Level 4: 14%
- Level 4 の代理店は子代理店を作成不可
- 登録時は `status=pending`、LINE友達追加で `active` に変更

---

### トラッキングリンク管理

#### POST /.netlify/functions/agency-create-link

**目的:** トラッキングリンク作成

**リクエスト:**
```json
{
  "name": "秋キャンペーン",
  "service_id": "b5e8f3c2-1a4d-4e9b-8f6a-2c3d4e5f6a7b",
  "utm_source": "facebook",
  "utm_medium": "cpc",
  "utm_campaign": "autumn2025",
  "utm_term": "task-management",
  "utm_content": "ad-variant-a"
}
```

**処理フロー:**
1. JWT認証
2. `service_id` から `services` テーブルのLINE URLを取得
3. トラッキングコード生成（12文字、重複チェック）
4. `agency_tracking_links` テーブルに挿入
5. トラッキングURL返却

**レスポンス（成功）:**
```json
{
  "success": true,
  "id": "uuid-...",
  "tracking_code": "abc123xyz789",
  "tracking_url": "https://agency.ikemen.ltd/t/abc123xyz789",
  "service_id": "b5e8f3c2-...",
  "line_friend_url": "https://lin.ee/FMy4xlx",
  "created_at": "2025-10-24T10:00:00Z"
}
```

---

#### GET /.netlify/functions/agency-links

**目的:** 代理店のトラッキングリンク一覧取得

**クエリパラメータ:**
- `service_id` (optional): サービスでフィルタ

**レスポンス（成功）:**
```json
{
  "links": [
    {
      "id": "uuid-...",
      "tracking_code": "abc123xyz",
      "name": "秋キャンペーン",
      "service_id": "uuid-...",
      "service_name": "TaskMate AI",
      "tracking_url": "https://agency.ikemen.ltd/t/abc123xyz",
      "visit_count": 150,
      "conversion_count": 25,
      "is_active": true,
      "created_at": "2025-10-01T00:00:00Z"
    }
  ]
}
```

---

### 統計情報

#### GET /.netlify/functions/agency-stats

**目的:** 代理店の統計情報取得

**クエリパラメータ:**
- `service_id` (optional): サービスでフィルタ（`all` または UUID）

**レスポンス（成功）:**
```json
{
  "totalLinks": 10,
  "totalClicks": 1500,
  "totalConversions": 250,
  "conversionRate": 16.7,
  "monthlyCommission": 500000,
  "lastMonthCommission": 450000,
  "totalCommission": 2500000
}
```

**計算ロジック:**
```javascript
// service_id でフィルタリング
if (service_id && service_id !== 'all') {
  query = query.eq('service_id', service_id);
}

conversionRate = (totalConversions / totalClicks) * 100;
```

---

### トラッキング

#### GET /.netlify/functions/track-redirect（/t/:tracking_code）

**目的:** トラッキングコードからLINE URLへリダイレクト

**処理フロー:**
1. `tracking_code` から `agency_tracking_links` 取得
2. 訪問情報記録（IP、User-Agent、Referrer解析）
3. `agency_tracking_visits` に挿入
4. `visit_count` をインクリメント
5. LINE友達追加URLへリダイレクト（302）

**訪問記録内容:**
- visitor_ip
- user_agent
- referrer
- device_type: `mobile`/`desktop`/`tablet`
- browser: `Chrome`/`Safari`/`LINE`
- os: `iOS`/`Android`/`Windows`
- session_id: `sess_{timestamp}_{random}`

**リダイレクトURL形式:**
```
https://lin.ee/FMy4xlx?tid=abc123xyz&sid=sess_abc123&aid=uuid-...&utm_source=facebook
```

---

### LINE Webhook

#### POST /.netlify/functions/line-webhook

**目的:** LINE友達追加イベントの処理

**処理フロー（follow イベント）:**
1. LINE署名検証
2. 代理店登録フローか確認（`agencies.line_user_id` に一致）
   - 一致する場合: 代理店を `active` に変更、ウェルカムメッセージ送信
3. 通常の友達追加として処理
4. 1時間以内の訪問記録と紐付け（`session_id` または IP で照合）
5. `agency_conversions` に `line_friend` コンバージョン記録
6. `tracking_links.conversion_count` インクリメント

**コンバージョン記録:**
```json
{
  "conversion_type": "line_friend",
  "conversion_value": 0,
  "line_user_id": "U1234...",
  "line_display_name": "山田太郎",
  "service_id": "uuid-..."
}
```

---

## ビジネスロジック

### コミッション計算

#### 階層別報酬率

```javascript
const COMMISSION_RATES = {
  1: 20.00,  // Level 1: 20%
  2: 18.00,  // Level 2: 18%
  3: 16.00,  // Level 3: 16%
  4: 14.00   // Level 4: 14%
};
```

#### 報酬計算式

**基本報酬（直接コンバージョン）:**
```
基本報酬 = サブスク月額料金 × 代理店報酬率 ÷ 100
```

**例:**
- TaskMate AI (月額10,000円)
- Level 2 代理店（報酬率18%）
- **報酬: 10,000 × 18 ÷ 100 = 1,800円**

**リファラル報酬（子代理店のコンバージョン）:**
```
リファラル報酬 = サブスク月額料金 × リファラル報酬率 ÷ 100
```

**例:**
- TaskMate AI (月額10,000円)
- リファラル報酬率 2%
- **報酬: 10,000 × 2 ÷ 100 = 200円**

#### 月次報酬計算

**実行タイミング:** 毎月1日（前月分を計算）

**処理フロー:**
1. 対象期間のコンバージョン取得
   ```sql
   SELECT * FROM agency_conversions
   WHERE agency_id = ?
     AND service_id = ?
     AND conversion_type = 'purchase'
     AND created_at >= '2025-10-01'
     AND created_at < '2025-11-01';
   ```

2. 総売上計算
   ```javascript
   total_sales = conversions.reduce((sum, c) => sum + c.conversion_value, 0);
   ```

3. 報酬額計算
   ```javascript
   commission_amount = total_sales × commission_rate / 100;
   ```

4. `agency_commissions` に記録
   ```sql
   INSERT INTO agency_commissions (
     agency_id, service_id, period_start, period_end,
     total_conversions, total_sales, commission_rate, commission_amount,
     status
   ) VALUES (?, ?, '2025-10-01', '2025-10-31', ?, ?, ?, ?, 'pending');
   ```

---

### リファラルシステム

#### 階層構造

```
Level 1 (親)
  ├─ Level 2 (子)
  │   ├─ Level 3 (孫)
  │   │   └─ Level 4 (ひ孫) ← 最大階層
  │   └─ Level 3
  └─ Level 2
```

#### 招待コード生成

```javascript
function generateAgencyCode() {
  const prefix = 'AG';
  const timestamp = Date.now().toString(36).toUpperCase();
  const random = Math.random().toString(36).substr(2, 4).toUpperCase();
  return `${prefix}${timestamp}${random}`;
}
// 例: AG1A2B3C4D
```

#### 登録時の階層決定

```javascript
// 親代理店取得
const parentAgency = await supabase
  .from('agencies')
  .select('level')
  .eq('code', invitation_code)
  .single();

// 新規代理店のレベル = 親レベル + 1
const newLevel = parentAgency.level + 1;

// 最大レベルチェック
if (newLevel > 4) {
  throw new Error('最大階層に達しています');
}
```

---

### マルチサービス対応

#### サービス選択時の動作

**リンク作成時:**
1. 代理店がサービスを選択
2. `agency_service_settings` からカスタム報酬率取得
   - 存在しない場合: `services.default_commission_rate` を使用
3. `services` からLINE URLを取得
4. `tracking_links.service_id` に保存

**統計表示時:**
1. `service_id` クエリパラメータでフィルタ
   ```javascript
   if (service_id && service_id !== 'all') {
     query = query.eq('service_id', service_id);
   }
   ```

**コンバージョン記録時:**
1. `tracking_link.service_id` を継承
2. `agency_conversions.service_id` に保存

**報酬計算時:**
1. サービスごとに別々に計算
2. `agency_commissions.service_id` で管理

---

## 認証・セキュリティ

### JWT認証

**発行:**
```javascript
const jwt = require('jsonwebtoken');

const token = jwt.sign(
  {
    userId: user.id,
    agencyId: agency.id,
    email: user.email,
    role: user.role
  },
  process.env.JWT_SECRET,
  { expiresIn: '7d' }
);
```

**検証:**
```javascript
const decoded = jwt.verify(token, process.env.JWT_SECRET);
// decoded.agencyId で代理店ID取得
```

**Cookie設定:**
```javascript
'Set-Cookie': `agencyAuthToken=${token}; Path=/; Max-Age=604800; HttpOnly; Secure; SameSite=Strict`
```

---

### CSRF保護

**検証条件:**
- Origin ヘッダーがホワイトリストに含まれる
- または Referer ヘッダーがホワイトリストに含まれる

```javascript
const ALLOWED_ORIGINS = [
  'https://agency.ikemen.ltd',
  'http://localhost:8888'
];

const origin = event.headers.origin;
const referer = event.headers.referer;

if (!ALLOWED_ORIGINS.some(allowed => origin?.startsWith(allowed) || referer?.startsWith(allowed))) {
  return { statusCode: 403, body: JSON.stringify({ error: 'CSRF check failed' }) };
}
```

---

### レート制限

**スパム登録攻撃対策:**
- 同一IPから1分間に5回までのリクエスト制限
- 違反時は 429 Too Many Requests

```javascript
const RATE_LIMIT = {
  windowMs: 60000,   // 1分
  maxRequests: 5
};
```

---

### パスワード

**ハッシュ化:**
```javascript
const bcrypt = require('bcryptjs');
const passwordHash = await bcrypt.hash(password, 10);
```

**検証:**
```javascript
const isValid = await bcrypt.compare(password, user.password_hash);
```

**要件:**
- 最小8文字
- 推奨: 英数字+記号

---

## デプロイ手順

### 1. Supabaseデータベース初期化

**Step 1: スキーマ作成**

```sql
-- database/001_create_services_table.sql を実行
-- マルチサービス対応テーブル作成
\i database/001_create_services_table.sql
```

**Step 2: 初期サービスデータ登録**

```sql
-- database/002_insert_initial_services.sql を実行
\i database/002_insert_initial_services.sql
```

**⚠️ 注意:** 実際のLINE認証情報に置き換えること
- `line_channel_id`
- `line_channel_secret`
- `line_channel_access_token`
- `line_official_url`

---

### 2. Netlify環境変数設定

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `SUPABASE_URL` | Supabase URL | `https://xxx.supabase.co` |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabaseサービスロールキー | `eyJ...` |
| `JWT_SECRET` | JWT署名用シークレット | `random-secret-key-here` |
| `ALLOWED_ORIGINS` | CORS許可オリジン | `https://agency.ikemen.ltd` |
| `LINE_CHANNEL_ID` | LINE Channel ID（デフォルト用） | `1234567890` |
| `LINE_CHANNEL_SECRET` | LINE Channel Secret | `xxx...` |
| `LINE_CHANNEL_ACCESS_TOKEN` | LINE Access Token | `yyy...` |
| `LINE_OFFICIAL_URL` | LINE公式アカウントURL | `https://lin.ee/xxx` |

---

### 3. カスタムドメイン設定

**推奨ドメイン:** `agency.ikemen.ltd`

1. Netlify Site Settings → Domain management
2. Add custom domain → `agency.ikemen.ltd`
3. DNS設定:
   ```
   Type: CNAME
   Name: agency
   Value: [netlify-site-name].netlify.app
   ```
4. SSL証明書自動発行（Let's Encrypt）

---

### 4. 動作確認

**チェックリスト:**

- [ ] `/agency` で代理店ダッシュボード表示
- [ ] `/admin` で管理画面表示
- [ ] 代理店新規登録が完了
- [ ] トラッキングリンク作成
- [ ] `/t/{tracking_code}` でリダイレクト動作
- [ ] LINE友達追加でコンバージョン記録
- [ ] ダッシュボードで統計表示
- [ ] サービスフィルタリング動作

---

## 付録

### 環境変数一覧

**Netlify（22個）:**

| カテゴリ | 変数名 | 必須 |
|---------|--------|------|
| **Supabase** | `SUPABASE_URL` | ✅ |
| | `SUPABASE_SERVICE_ROLE_KEY` | ✅ |
| | `SUPABASE_ANON_KEY` | |
| **JWT** | `JWT_SECRET` | ✅ |
| **LINE** | `LINE_CHANNEL_ID` | ✅ |
| | `LINE_CHANNEL_SECRET` | ✅ |
| | `LINE_CHANNEL_ACCESS_TOKEN` | ✅ |
| | `LINE_OFFICIAL_URL` | ✅ |
| **管理** | `ADMIN_USERNAME` | ✅ |
| | `ADMIN_PASSWORD` | ✅ |
| **CORS** | `ALLOWED_ORIGINS` | |
| **Stripe** | `STRIPE_SECRET_KEY` | |
| | `STRIPE_WEBHOOK_SECRET` | |
| **その他** | `RENDER_WEBHOOK_URL` | |

---

### よくある質問

**Q1: 代理店登録後、ログインできません**

A: 代理店のステータスが `pending` の可能性があります。LINE友達追加を完了して `active` にしてください。

**Q2: トラッキングリンクが動作しません**

A: 以下を確認:
1. リンクが `is_active=true` か
2. `service_id` が正しく設定されているか
3. サービスの `line_official_url` が有効か

**Q3: コンバージョンが記録されません**

A: 以下を確認:
1. LINE Webhook URLが正しく設定されているか（`https://agency.ikemen.ltd/.netlify/functions/line-webhook`）
2. LINE Channel Secretが正しいか
3. 訪問とLINE友達追加の時間差が1時間以内か

**Q4: 報酬が計算されません**

A: 月次報酬計算は管理者が手動実行する必要があります。`/.netlify/functions/agency-commission` を呼び出してください。

---

**設計書バージョン:** 2.0
**作成日:** 2025-10-24
**作成者:** Claude Code

