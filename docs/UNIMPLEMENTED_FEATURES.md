# æœªå®Ÿè£…æ©Ÿèƒ½ä¸€è¦§

**èª¿æŸ»æ—¥**: 2025-10-25
**èª¿æŸ»å¯¾è±¡**: ã‚¤ã‚±ãƒ¡ãƒ³ä»£ç†åº—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
**èª¿æŸ»ç¯„å›²**: ä»£ç†åº—ç”»é¢ï¼ˆagency/ï¼‰ã€ç®¡ç†ç”»é¢ï¼ˆadmin/ï¼‰ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«

---

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒžãƒªãƒ¼

æœ¬èª¿æŸ»ã§ã¯ã€ã‚¤ã‚±ãƒ¡ãƒ³ä»£ç†åº—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ¨ªæ–­çš„ã«åˆ†æžã—ã€æœªå®Ÿè£…æ©Ÿèƒ½ã‚’ç‰¹å®šã—ã¾ã—ãŸã€‚

**ä¸»ãªç™ºè¦‹:**
- ä»£ç†åº—ç”»é¢ã§2ã¤ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæœªå®Ÿè£…
- 4æ®µéšŽä»£ç†åº—åˆ¶åº¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å®Ÿè£…æ¸ˆã¿ã ãŒã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¡¨ç¤ºãŒä¸€éƒ¨æœªå®Œæˆ
- ç®¡ç†ç”»é¢ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã¯å…¨ã¦å®Ÿè£…æ¸ˆã¿
- æœªä½¿ç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¤‡æ•°å­˜åœ¨ï¼ˆTaskMate AIé–¢é€£æ©Ÿèƒ½ï¼‰

---

## 1. ä»£ç†åº—ç”»é¢ï¼ˆ/agency/ï¼‰

### 1.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã¿å®Ÿè£…ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãªã—ï¼‰

#### âŒ éšŽå±¤æƒ…å ±APIï¼ˆ4æ®µéšŽä»£ç†åº—åˆ¶åº¦ï¼‰
- **å ´æ‰€**: `agency/dashboard.js:1607-1633`
- **èª¬æ˜Ž**: ä»£ç†åº—ã®è¦ªå­é–¢ä¿‚ï¼ˆéšŽå±¤ãƒã‚§ãƒ¼ãƒ³ï¼‰ã¨å­ä»£ç†åº—ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹API
- **å¿…è¦ãªAPI**: `/.netlify/functions/agency-referral-info`
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…çŠ¶æ³**:
  - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…æ¸ˆã¿ï¼ˆ404ã‚¨ãƒ©ãƒ¼ã¯æ­£å¸¸ã¨ã—ã¦æ‰±ã†ï¼‰
  - ç©ºãƒ‡ãƒ¼ã‚¿ã§åˆæœŸåŒ–ã•ã‚Œã‚‹
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«**:
  - âœ… `agencies.parent_agency_id` ã‚«ãƒ©ãƒ å­˜åœ¨
  - âœ… `agencies.level` ã‚«ãƒ©ãƒ å­˜åœ¨
  - âœ… `get_agency_hierarchy()` é–¢æ•°å®Ÿè£…æ¸ˆã¿
- **è¿”å´ã™ã¹ããƒ‡ãƒ¼ã‚¿æ§‹é€ **:
```javascript
{
  childAgencies: [
    { id, code, name, level, own_commission_rate, created_at }
  ],
  totalChildren: 0,
  hierarchyChain: [
    { agency_id, level, own_commission_rate, parent_agency_id }
  ]
}
```
- **å„ªå…ˆåº¦**: **Medium** - 4æ®µéšŽä»£ç†åº—åˆ¶åº¦ã®éšŽå±¤å¯è¦–åŒ–ã«å¿…è¦ã ãŒã€ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—ã«ã¯ä¸è¦

---

#### âŒ ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è©³ç´°å±¥æ­´APIï¼ˆ4æ®µéšŽä»£ç†åº—åˆ¶åº¦ï¼‰
- **å ´æ‰€**: `agency/dashboard.js:1637-1674`
- **èª¬æ˜Ž**: è‡ªå·±å ±é…¬ã¨ãƒªãƒ•ã‚¡ãƒ©ãƒ«å ±é…¬ã®è©³ç´°ãªå†…è¨³ã¨å±¥æ­´ã‚’å–å¾—ã™ã‚‹API
- **å¿…è¦ãªAPI**: `/.netlify/functions/agency-commission-details`
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…çŠ¶æ³**:
  - ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆæ¸ˆã¿ï¼ˆFuture implementationï¼‰
  - ç¾åœ¨ã¯ç©ºé…åˆ—ã‚’è¿”ã™
  - `loadingCommissions` ãƒ•ãƒ©ã‚°ã¯å®Ÿè£…æ¸ˆã¿
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«**:
  - âœ… `agency_commission_distributions` ãƒ†ãƒ¼ãƒ–ãƒ«å®Ÿè£…æ¸ˆã¿
  - âœ… ä»¥ä¸‹ã®ã‚«ãƒ©ãƒ ãŒå­˜åœ¨:
    - `commission_type` (own/referral)
    - `deal_amount` (æ¡ˆä»¶ç·é¡)
    - `closing_agency_id` (æˆç´„ã—ãŸä»£ç†åº—)
    - `agency_level` (éšŽå±¤ãƒ¬ãƒ™ãƒ«)
    - `payment_status` (pending/approved/paid/cancelled)
- **è¿”å´ã™ã¹ããƒ‡ãƒ¼ã‚¿æ§‹é€ **:
```javascript
{
  commissionDetails: [
    {
      id,
      conversion_id,
      commission_type, // 'own' or 'referral'
      deal_amount,
      commission_rate,
      commission_amount,
      closing_agency_name, // æˆç´„ä»£ç†åº—å
      agency_level,
      payment_status,
      paid_at,
      created_at
    }
  ]
}
```
- **å„ªå…ˆåº¦**: **High** - 4æ®µéšŽä»£ç†åº—åˆ¶åº¦ã®å ±é…¬é€æ˜Žæ€§ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«é‡è¦

---

### 1.2 è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãŒå‹•ä½œã—ãªã„æ©Ÿèƒ½

#### âš ï¸ å ±é…¬ã‚¿ãƒ–ã®ã€Œã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ã€ãƒœã‚¿ãƒ³
- **å ´æ‰€**: `agency/index.html:804` - ã‚¿ãƒ–ãƒœã‚¿ãƒ³
- **èª¬æ˜Ž**: å ±é…¬ã‚¿ãƒ–ã‚’é–‹ãã¨ `loadCommissionHistory()` ãŒå‘¼ã°ã‚Œã‚‹ãŒã€APIãŒæœªå®Ÿè£…ã®ãŸã‚ç©ºãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- **å½±éŸ¿**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œãªã„
- **ã‚¨ãƒ©ãƒ¼è¡¨ç¤º**: ãªã—ï¼ˆ404ã‚¨ãƒ©ãƒ¼ã‚’æ­£å¸¸ã¨ã—ã¦æ‰±ã†è¨­è¨ˆï¼‰
- **å„ªå…ˆåº¦**: **High** - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœŸå¾…ã™ã‚‹æ©Ÿèƒ½ãŒå‹•ä½œã—ãªã„

---

### 1.3 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã‚ã‚‹ãŒæœªä½¿ç”¨

#### ðŸ“Š 4æ®µéšŽä»£ç†åº—åˆ¶åº¦ã®å®Œå…¨å®Ÿè£…
- **ãƒ†ãƒ¼ãƒ–ãƒ«**: `agency_commission_distributions`
- **ã‚«ãƒ©ãƒ æ•°**: 12ã‚«ãƒ©ãƒ 
- **é–¢é€£æ©Ÿèƒ½**:
  - æˆç´„æ™‚ã®å ±é…¬è‡ªå‹•åˆ†é…
  - ãƒªãƒ•ã‚¡ãƒ©ãƒ«ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—ï¼ˆå›ºå®š2%ï¼‰
  - éšŽå±¤åˆ¥å ±é…¬çŽ‡ï¼ˆLevel 1: 20%, Level 2: 18%, Level 3: 16%, Level 4: 14%ï¼‰
- **ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°**:
  - âœ… `get_agency_hierarchy(start_agency_id UUID)` - éšŽå±¤ãƒã‚§ãƒ¼ãƒ³å–å¾—
  - âœ… `get_standard_commission_rate(agency_level INTEGER)` - æ¨™æº–å ±é…¬çŽ‡å–å¾—
- **èª²é¡Œ**:
  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«å ±é…¬è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ãŒæœªå®Ÿè£…
  - å ±é…¬åˆ†é…ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒˆãƒªã‚¬ãƒ¼ãŒæœªå®Ÿè£…ï¼ˆWebhookç­‰ï¼‰
- **å„ªå…ˆåº¦**: **High** - ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ã®ä¸­æ ¸æ©Ÿèƒ½

---

## 2. ç®¡ç†ç”»é¢ï¼ˆ/admin/ï¼‰

### 2.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã¿å®Ÿè£…ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãªã—ï¼‰

**è©²å½“ãªã—** - ç®¡ç†ç”»é¢ã§å‘¼ã°ã‚Œã¦ã„ã‚‹å…¨ã¦ã®APIãŒå®Ÿè£…æ¸ˆã¿:
- âœ… `validate-admin` - ç®¡ç†è€…èªè¨¼
- âœ… `get-tracking-stats` - çµ±è¨ˆæƒ…å ±å–å¾—
- âœ… `create-tracking-link` - ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ä½œæˆ
- âœ… `admin-agencies` - ä»£ç†åº—ç®¡ç†ï¼ˆGET/POSTï¼‰

---

### 2.2 è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãŒå‹•ä½œã—ãªã„æ©Ÿèƒ½

**è©²å½“ãªã—** - ç®¡ç†ç”»é¢ã®å…¨æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œ

---

### 2.3 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã‚ã‚‹ãŒæœªä½¿ç”¨

#### ðŸ“¦ TaskMate AIé–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚·ã‚¹ãƒ†ãƒ å¤–æ©Ÿèƒ½ï¼‰

ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€TaskMate AIã®ä¼šè©±å±¥æ­´ã‚„ã‚³ãƒ¼ãƒ‰ç”Ÿæˆæ©Ÿèƒ½ã§ä½¿ç”¨ã•ã‚Œã‚‹ãŒã€ä»£ç†åº—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¨ã¯ç‹¬ç«‹ã—ã¦ã„ã‚‹:

1. **conversations** - ä¼šè©±å±¥æ­´
2. **conversation_contexts** - ä¼šè©±ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
3. **session_checkpoints** - ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
4. **code_revisions** - ã‚³ãƒ¼ãƒ‰æ”¹è¨‚å±¥æ­´
5. **code_shares** - ã‚³ãƒ¼ãƒ‰å…±æœ‰
6. **code_share_access_logs** - ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°
7. **conversation_code_relations** - ä¼šè©±ã¨ã‚³ãƒ¼ãƒ‰ã®é–¢é€£ä»˜ã‘
8. **user_code_history** - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰å±¥æ­´
9. **code_quality_checks** - ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
10. **generated_codes** - ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰
11. **requirement_extractions** - è¦ä»¶æŠ½å‡º
12. **professional_support_tickets** - ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã‚µãƒãƒ¼ãƒˆãƒã‚±ãƒƒãƒˆ
13. **vision_usage** - Vision APIä½¿ç”¨çŠ¶æ³

**å‚™è€ƒ**: ã“ã‚Œã‚‰ã¯TaskMate AIã‚µãƒ¼ãƒ“ã‚¹æœ¬ä½“ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã‚ã‚Šã€ä»£ç†åº—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ç›´æŽ¥ä½¿ç”¨ã—ãªã„ã€‚

---

## 3. ç›¸äº’é€£æºã®å•é¡Œ

### 3.1 ä»£ç†åº—â†’ç®¡ç†ç”»é¢ã®é€£æºä¸è¶³

#### âœ… é€£æºæ¸ˆã¿
- ä»£ç†åº—ç™»éŒ² â†’ ç®¡ç†ç”»é¢ã§æ‰¿èª
- ä»£ç†åº—ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ â†’ ç®¡ç†ç”»é¢ã§çµ±è¨ˆè¡¨ç¤º
- ä»£ç†åº—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ â†’ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åæ˜ 

#### âš ï¸ ä¸€éƒ¨æœªå®Ÿè£…
- **4æ®µéšŽä»£ç†åº—åˆ¶åº¦ã®éšŽå±¤è¡¨ç¤º**
  - ç®¡ç†ç”»é¢ã§ä»£ç†åº—ã®è¦ªå­é–¢ä¿‚ï¼ˆéšŽå±¤ãƒ„ãƒªãƒ¼ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ãŒæœªå®Ÿè£…
  - `admin/index.html` ã«éšŽå±¤è¡¨ç¤ºUIãŒãªã„
  - `admin-agencies.js` APIã¯éšŽå±¤ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ã¦ã„ãªã„
  - **å„ªå…ˆåº¦**: Medium

---

### 3.2 ç®¡ç†ç”»é¢â†’ä»£ç†åº—ã®é€£æºä¸è¶³

#### âœ… é€£æºæ¸ˆã¿
- ç®¡ç†ç”»é¢ã§ä»£ç†åº—æ‰¿èª â†’ ä»£ç†åº—ç”»é¢ã§ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½
- ç®¡ç†ç”»é¢ã§ä»£ç†åº—ä¸€æ™‚åœæ­¢ â†’ ä»£ç†åº—ç”»é¢ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸å¯

#### âŒ æœªå®Ÿè£…
- **ç®¡ç†ç”»é¢ã‹ã‚‰ã®ä¸€æ‹¬é€šçŸ¥æ©Ÿèƒ½**
  - ç®¡ç†ç”»é¢ã‹ã‚‰ä»£ç†åº—ã¸ã®ãƒ¡ãƒ¼ãƒ«é€šçŸ¥æ©Ÿèƒ½ãŒæœªå®Ÿè£…
  - æ‰¿èª/éžæ‰¿èªæ™‚ã®è‡ªå‹•é€šçŸ¥ãŒãªã„
  - **å¿…è¦ãªãƒ†ãƒ¼ãƒ–ãƒ«**: notification_logs, email_templates
  - **å„ªå…ˆåº¦**: Low

---

## 4. å„ªå…ˆåº¦åˆ¥å®Ÿè£…æŽ¨å¥¨é †åº

### Highï¼ˆã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ« - ãƒ“ã‚¸ãƒã‚¹å½±éŸ¿å¤§ï¼‰

#### 1. âœ… ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è©³ç´°å±¥æ­´API (`agency-commission-details`)
- **ç†ç”±**: 4æ®µéšŽä»£ç†åº—åˆ¶åº¦ã®å ±é…¬é€æ˜Žæ€§ç¢ºä¿ã®ãŸã‚å¿…é ˆ
- **å·¥æ•°è¦‹ç©**: 3-5æ—¥
- **å¿…è¦ãªå®Ÿè£…**:
  - APIä½œæˆ: `netlify/functions/agency-commission-details.js`
  - SQL: `agency_commission_distributions` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
  - JOIN: `agencies`, `agency_conversions` ãƒ†ãƒ¼ãƒ–ãƒ«
  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: æ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤ï¼‰
- **ä¾å­˜é–¢ä¿‚**:
  - Stripe Webhookã§ã®ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ²
  - ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³åˆ†é…ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…

#### 2. ðŸ“Š å ±é…¬åˆ†é…ãƒˆãƒªã‚¬ãƒ¼ã®å®Ÿè£…
- **ç†ç”±**: 4æ®µéšŽä»£ç†åº—åˆ¶åº¦ã®è‡ªå‹•å ±é…¬è¨ˆç®—ã«å¿…é ˆ
- **å·¥æ•°è¦‹ç©**: 5-7æ—¥
- **å¿…è¦ãªå®Ÿè£…**:
  - Stripe Webhook (`stripe-webhook.js`) ã®æ‹¡å¼µ
  - éšŽå±¤ãƒã‚§ãƒ¼ãƒ³å–å¾—ã¨ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
  - `agency_commission_distributions` ã¸ã®è‡ªå‹•INSERT
  - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
- **ä¾å­˜é–¢ä¿‚**:
  - `get_agency_hierarchy()` é–¢æ•°ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
  - `get_standard_commission_rate()` é–¢æ•°ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

---

### Mediumï¼ˆé‡è¦ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Šï¼‰

#### 3. ðŸ¢ éšŽå±¤æƒ…å ±API (`agency-referral-info`)
- **ç†ç”±**: ä»£ç†åº—ãŒè‡ªåˆ†ã®å­ä»£ç†åº—ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- **å·¥æ•°è¦‹ç©**: 2-3æ—¥
- **å¿…è¦ãªå®Ÿè£…**:
  - APIä½œæˆ: `netlify/functions/agency-referral-info.js`
  - SQL: `get_agency_hierarchy()` é–¢æ•°ã‚’ä½¿ç”¨
  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: æ—¢ã«å®Ÿè£…æ¸ˆã¿
- **ä¾å­˜é–¢ä¿‚**: ãªã—ï¼ˆå˜ç‹¬ã§å®Ÿè£…å¯èƒ½ï¼‰

#### 4. ðŸ“‹ ç®¡ç†ç”»é¢ã§ã®éšŽå±¤ãƒ„ãƒªãƒ¼è¡¨ç¤º
- **ç†ç”±**: ç®¡ç†è€…ãŒä»£ç†åº—ã®è¦ªå­é–¢ä¿‚ã‚’æŠŠæ¡ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- **å·¥æ•°è¦‹ç©**: 3-4æ—¥
- **å¿…è¦ãªå®Ÿè£…**:
  - `admin-agencies.js` APIã®æ‹¡å¼µï¼ˆéšŽå±¤ãƒ‡ãƒ¼ã‚¿è¿½åŠ ï¼‰
  - `admin/index.html` ã«ãƒ„ãƒªãƒ¼è¡¨ç¤ºUIè¿½åŠ 
  - JavaScript: å†å¸°çš„ãªãƒ„ãƒªãƒ¼æ§‹é€ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
- **ä¾å­˜é–¢ä¿‚**: agency-referral-info API

---

### Lowï¼ˆã‚ã‚Œã°ä¾¿åˆ©ï¼‰

#### 5. ðŸ“§ ç®¡ç†ç”»é¢ã‹ã‚‰ã®ä¸€æ‹¬é€šçŸ¥æ©Ÿèƒ½
- **ç†ç”±**: ä»£ç†åº—ã¸ã®é€£çµ¡ã‚’åŠ¹çŽ‡åŒ–
- **å·¥æ•°è¦‹ç©**: 5-7æ—¥
- **å¿…è¦ãªå®Ÿè£…**:
  - ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ: `notification_logs`, `email_templates`
  - APIä½œæˆ: `admin-send-notification.js`
  - ãƒ¡ãƒ¼ãƒ«é€ä¿¡: SendGrid/AWS SESçµ±åˆ
  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: é€šçŸ¥é€ä¿¡UI
- **ä¾å­˜é–¢ä¿‚**: ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ã®å¥‘ç´„

#### 6. ðŸ“Š ä»£ç†åº—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆç®¡ç†ç”»é¢ï¼‰
- **ç†ç”±**: ç®¡ç†è€…ãŒå…¨ä»£ç†åº—ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã‚’ä¸€è¦§ã§ç¢ºèª
- **å·¥æ•°è¦‹ç©**: 4-5æ—¥
- **å¿…è¦ãªå®Ÿè£…**:
  - APIä½œæˆ: `admin-analytics.js`
  - SQL: é›†è¨ˆã‚¯ã‚¨ãƒªï¼ˆä»£ç†åº—åˆ¥å£²ä¸Šã€CVæ•°ã€CVRï¼‰
  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: Chart.js ã§ã‚°ãƒ©ãƒ•è¡¨ç¤º
- **ä¾å­˜é–¢ä¿‚**: ãªã—

---

## 5. æŠ€è¡“çš„è©³ç´°

### 5.1 æœªå®Ÿè£…APIã®ä»•æ§˜æ›¸

#### API: `agency-referral-info`
```javascript
// GET /.netlify/functions/agency-referral-info
// Headers: Authorization: Bearer {token}, X-Agency-Id: {agencyId}

// Response:
{
  "childAgencies": [
    {
      "id": "uuid",
      "code": "AG001-SUB01",
      "name": "æ ªå¼ä¼šç¤¾ã‚µãƒ–ä»£ç†åº—",
      "level": 2,
      "own_commission_rate": 18.00,
      "created_at": "2025-01-01T00:00:00Z",
      "total_conversions": 10,
      "total_commission": 36000
    }
  ],
  "totalChildren": 1,
  "hierarchyChain": [
    {
      "agency_id": "uuid",
      "level": 1,
      "own_commission_rate": 20.00,
      "parent_agency_id": null
    },
    {
      "agency_id": "uuid",
      "level": 2,
      "own_commission_rate": 18.00,
      "parent_agency_id": "parent-uuid"
    }
  ]
}
```

**å®Ÿè£…SQL:**
```sql
-- å­ä»£ç†åº—ãƒªã‚¹ãƒˆ
SELECT
  a.id, a.code, a.name, a.level, a.own_commission_rate, a.created_at,
  COUNT(ac.id) as total_conversions,
  COALESCE(SUM(acd.commission_amount), 0) as total_commission
FROM agencies a
LEFT JOIN agency_conversions ac ON ac.agency_id = a.id
LEFT JOIN agency_commission_distributions acd ON acd.agency_id = a.id
WHERE a.parent_agency_id = $1
GROUP BY a.id;

-- éšŽå±¤ãƒã‚§ãƒ¼ãƒ³
SELECT * FROM get_agency_hierarchy($1);
```

---

#### API: `agency-commission-details`
```javascript
// GET /.netlify/functions/agency-commission-details
// Headers: Authorization: Bearer {token}, X-Agency-Id: {agencyId}
// Query Params: ?period_start=2025-01-01&period_end=2025-01-31

// Response:
{
  "commissionDetails": [
    {
      "id": "uuid",
      "conversion_id": "uuid",
      "commission_type": "own", // or "referral"
      "deal_amount": 10000,
      "commission_rate": 20.00,
      "commission_amount": 2000,
      "closing_agency_id": "uuid",
      "closing_agency_name": "æ ªå¼ä¼šç¤¾ã‚¤ã‚±ãƒ¡ãƒ³",
      "agency_level": 1,
      "payment_status": "paid",
      "paid_at": "2025-02-01T00:00:00Z",
      "created_at": "2025-01-15T10:30:00Z",
      "conversion_type": "line_friend",
      "user_email": "user@example.com"
    }
  ],
  "summary": {
    "total_own_commission": 150000,
    "total_referral_commission": 30000,
    "total_paid": 120000,
    "total_pending": 60000,
    "period": "2025å¹´1æœˆ"
  }
}
```

**å®Ÿè£…SQL:**
```sql
SELECT
  acd.id,
  acd.conversion_id,
  acd.commission_type,
  acd.deal_amount,
  acd.commission_rate,
  acd.commission_amount,
  acd.closing_agency_id,
  closing.name as closing_agency_name,
  acd.agency_level,
  acd.payment_status,
  acd.paid_at,
  acd.created_at,
  ac.conversion_type,
  u.email as user_email
FROM agency_commission_distributions acd
INNER JOIN agencies closing ON closing.id = acd.closing_agency_id
LEFT JOIN agency_conversions ac ON ac.id = acd.conversion_id
LEFT JOIN users u ON u.id = ac.user_id
WHERE acd.agency_id = $1
  AND acd.created_at >= $2
  AND acd.created_at <= $3
ORDER BY acd.created_at DESC;
```

---

### 5.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ä½¿ç”¨çŠ¶æ³

| ãƒ†ãƒ¼ãƒ–ãƒ«å | ä½¿ç”¨çŠ¶æ³ | ä½¿ç”¨ç®‡æ‰€ | å‚™è€ƒ |
|-----------|---------|---------|------|
| `agencies` | âœ… ä½¿ç”¨ä¸­ | å…¨API | ä»£ç†åº—ãƒžã‚¹ã‚¿ãƒ¼ |
| `agency_users` | âœ… ä½¿ç”¨ä¸­ | agency-auth | ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ |
| `agency_tracking_links` | âœ… ä½¿ç”¨ä¸­ | agency-links, agency-create-link | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ç®¡ç† |
| `agency_tracking_visits` | âœ… ä½¿ç”¨ä¸­ | agency-analytics, track-visit | è¨ªå•è¨˜éŒ² |
| `agency_conversions` | âœ… ä½¿ç”¨ä¸­ | agency-analytics, stripe-webhook | ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ² |
| `agency_commissions` | âœ… ä½¿ç”¨ä¸­ | agency-commissions | æœˆæ¬¡å ±é…¬é›†è¨ˆ |
| `agency_commission_distributions` | âŒ æœªä½¿ç”¨ | - | **4æ®µéšŽä»£ç†åº—åˆ¶åº¦ã®å ±é…¬åˆ†é…** |
| `services` | âœ… ä½¿ç”¨ä¸­ | agency-services | ã‚µãƒ¼ãƒ“ã‚¹ãƒžã‚¹ã‚¿ãƒ¼ |
| `agency_service_settings` | âš ï¸ ä¸€éƒ¨ä½¿ç”¨ | - | ã‚µãƒ¼ãƒ“ã‚¹åˆ¥è¨­å®šï¼ˆæœªå®Œå…¨å®Ÿè£…ï¼‰ |
| `password_reset_tokens` | âœ… ä½¿ç”¨ä¸­ | password-reset-request, password-reset-confirm | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ |
| `user_sessions` | âŒ æœªä½¿ç”¨ | - | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆæœªå®Ÿè£…ï¼‰ |
| `stripe_payments` | âš ï¸ ä¸€éƒ¨ä½¿ç”¨ | stripe-webhook | Stripeæ±ºæ¸ˆè¨˜éŒ² |
| `conversations` | âŒ åˆ¥ã‚·ã‚¹ãƒ†ãƒ  | TaskMate AI | ä»£ç†åº—ã‚·ã‚¹ãƒ†ãƒ ã§ã¯æœªä½¿ç”¨ |
| `code_shares` | âŒ åˆ¥ã‚·ã‚¹ãƒ†ãƒ  | TaskMate AI | ä»£ç†åº—ã‚·ã‚¹ãƒ†ãƒ ã§ã¯æœªä½¿ç”¨ |

---

## 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æ‡¸å¿µäº‹é …

### 6.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- âœ… JWTèªè¨¼å®Ÿè£…æ¸ˆã¿
- âœ… Row Level Security (RLS) å®Ÿè£…æ¸ˆã¿
- âœ… CSRFä¿è­·å®Ÿè£…æ¸ˆã¿
- âš ï¸ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒä¸€éƒ¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§æœªå®Ÿè£…
  - `agency-referral-info` (æœªä½œæˆ)
  - `agency-commission-details` (æœªä½œæˆ)

### 6.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹
- âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆæ¸ˆã¿ï¼ˆä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- âœ… å†å¸°ã‚¯ã‚¨ãƒªæœ€é©åŒ–æ¸ˆã¿ (`get_agency_hierarchy`)
- âš ï¸ N+1ã‚¯ã‚¨ãƒªã®å¯èƒ½æ€§ï¼ˆ`agency-commission-details` ã§JOINå¤šæ•°ï¼‰
  - æŽ¨å¥¨: JOINã®æœ€é©åŒ–ã¨EXPLAIN ANALYZEå®Ÿæ–½

---

## 7. æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³

### Phase 1: ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«æ©Ÿèƒ½å®Ÿè£…ï¼ˆ2-3é€±é–“ï¼‰
1. âœ… `agency-commission-details` APIå®Ÿè£…
2. âœ… Stripe Webhookã§ã®å ±é…¬åˆ†é…ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
3. âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆè§£é™¤ã¨ãƒ†ã‚¹ãƒˆ

### Phase 2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Šï¼ˆ1-2é€±é–“ï¼‰
4. âœ… `agency-referral-info` APIå®Ÿè£…
5. âœ… ç®¡ç†ç”»é¢ã§ã®éšŽå±¤ãƒ„ãƒªãƒ¼è¡¨ç¤º

### Phase 3: é‹ç”¨åŠ¹çŽ‡åŒ–ï¼ˆ2-3é€±é–“ï¼‰
6. âœ… ä¸€æ‹¬é€šçŸ¥æ©Ÿèƒ½å®Ÿè£…
7. âœ… ç®¡ç†ç”»é¢ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

---

## 8. ã¾ã¨ã‚

### å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½ï¼ˆé«˜è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆï¼‰
- âœ… ä»£ç†åº—èªè¨¼ãƒ»ç™»éŒ²ã‚·ã‚¹ãƒ†ãƒ 
- âœ… ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ç®¡ç†
- âœ… LINEé€£æº
- âœ… è¨ªå•åˆ†æžãƒ»ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ²
- âœ… åŸºæœ¬çš„ãªå ±é…¬è¨ˆç®—
- âœ… ç®¡ç†ç”»é¢ã§ã®ä»£ç†åº—æ‰¿èªãƒ•ãƒ­ãƒ¼
- âœ… 4æ®µéšŽä»£ç†åº—åˆ¶åº¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### æœªå®Ÿè£…æ©Ÿèƒ½ï¼ˆæ”¹å–„ãŒå¿…è¦ï¼‰
- âŒ 4æ®µéšŽä»£ç†åº—åˆ¶åº¦ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¡¨ç¤º
- âŒ å ±é…¬åˆ†é…ã®è‡ªå‹•åŒ–
- âŒ éšŽå±¤æƒ…å ±APIã¨ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è©³ç´°API

### ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ
- **High**: 4æ®µéšŽä»£ç†åº—åˆ¶åº¦ãŒå®Œå…¨ç¨¼åƒã—ã¦ã„ãªã„ãŸã‚ã€ãƒªãƒ•ã‚¡ãƒ©ãƒ«å ±é…¬ãŒæ”¯æ‰•ã‚ã‚Œã¦ã„ãªã„å¯èƒ½æ€§
- **Medium**: ä»£ç†åº—ãŒè‡ªåˆ†ã®å­ä»£ç†åº—ã‚’ç¢ºèªã§ããªã„ãŸã‚ã€å–¶æ¥­æ´»å‹•ãŒåˆ¶é™ã•ã‚Œã‚‹
- **Low**: ç®¡ç†è€…ã®é‹ç”¨è² è·ãŒé«˜ã„ï¼ˆæ‰‹å‹•é€šçŸ¥ã€æ‰‹å‹•é›†è¨ˆï¼‰

---

**èª¿æŸ»æ‹…å½“**: Claude (Anthropic)
**èª¿æŸ»å®Œäº†æ—¥**: 2025-10-25
